#!/usr/bin/env zsh

# =============================================================================
# Arch Package Manager - Main Entry Point
# Version: 2.1.0
# =============================================================================

# Get script directory
SCRIPT_DIR="${0:A:h}"
LIB_DIR="${SCRIPT_DIR}/../lib"

# =============================================================================
# Load Core Modules
# =============================================================================

# Load colors and icons
source "${LIB_DIR}/core/colors.zsh"

# Load UI components
source "${LIB_DIR}/core/ui.zsh"

# Load system detection
source "${LIB_DIR}/core/detect.zsh"

# Load utilities
source "${LIB_DIR}/core/utils.zsh"

# =============================================================================
# Load Feature Modules
# =============================================================================

# Check if module file exists before sourcing
load_module() {
    local module=$1
    local module_file="${LIB_DIR}/${module}"

    if [[ -f "$module_file" ]]; then
        source "$module_file"
    else
        echo "Warning: Module not found: $module_file" >&2
    fi
}

# Load all package management modules
load_module "package/install.zsh"
load_module "package/remove.zsh"
load_module "package/update.zsh"
load_module "package/search.zsh"
load_module "package/info.zsh"

# Load system maintenance modules
load_module "system/cache.zsh"
load_module "system/orphan.zsh"
load_module "system/broken.zsh"
load_module "system/list.zsh"

# Load advanced feature modules
load_module "advanced/downgrade.zsh"
load_module "advanced/logs.zsh"
load_module "advanced/mirror.zsh"
load_module "advanced/yay.zsh"

# Load font management modules
load_module "font/menu.zsh"
load_module "font/install.zsh"
load_module "font/manage.zsh"
load_module "font/test.zsh"

# Load development tools modules
load_module "devtools/menu.zsh"
load_module "devtools/web.zsh"
load_module "devtools/database.zsh"
load_module "devtools/language.zsh"
load_module "devtools/devops.zsh"

# =============================================================================
# Main Menu
# =============================================================================

show_main_menu() {
    local aur_helper=$(detect_aur_helper)
    local flatpak_status=""

    if has_flatpak; then
        flatpak_status="$(badge "INSTALLED" "success")"
    else
        flatpak_status="$(badge "NOT INSTALLED" "error")"
    fi

    # System status bar
    echo -e "${SKY}${RBOX_TL}$(printf "${RBOX_H}%.0s" $(seq 1 63))${RBOX_TR}${RESET}"
    if [[ -n "$aur_helper" ]]; then
        echo -e "${SKY}${RBOX_V}${RESET} ${ICON_SHIELD} AUR Helper: $(badge "$aur_helper" "success")  ${ICON_PACKAGE} Flatpak: ${flatpak_status} ${SKY}${RBOX_V}${RESET}"
    else
        echo -e "${SKY}${RBOX_V}${RESET} ${ICON_WARNING} AUR Helper: $(badge "NOT INSTALLED" "warning")  ${ICON_PACKAGE} Flatpak: ${flatpak_status} ${SKY}${RBOX_V}${RESET}"
    fi
    echo -e "${SKY}${RBOX_BL}$(printf "${RBOX_H}%.0s" $(seq 1 63))${RBOX_BR}${RESET}"

    # Package Management Section
    section_header "H·ªÜ TH·ªêNG G√ìI" "${ICON_PACKAGE}"
    menu_item "1" "C√†i ƒë·∫∑t g√≥i" "${ICON_DOWNLOAD}"
    menu_item "2" "X√≥a g√≥i" "${ICON_TRASH}"
    menu_item "3" "C·∫≠p nh·∫≠t h·ªá th·ªëng" "${ICON_UPDATE}"
    menu_item "4" "T√¨m ki·∫øm g√≥i" "${ICON_SEARCH}"
    menu_item "5" "Xem th√¥ng tin g√≥i" "${ICON_INFO}"

    # System Maintenance Section
    section_header "B·∫¢O TR√å H·ªÜ TH·ªêNG" "${ICON_CLEAN}"
    menu_item "6" "D·ªçn d·∫πp cache" "${ICON_CLEAN}"
    menu_item "7" "X√≥a g√≥i orphan (kh√¥ng c·∫ßn thi·∫øt)" "${ICON_TRASH}"
    menu_item "8" "Xem danh s√°ch g√≥i ƒë√£ c√†i" "${ICON_CHECK}"
    menu_item "9" "Ki·ªÉm tra g√≥i b·ªã h·ªèng" "${ICON_SHIELD}"

    # Advanced Section
    section_header "N√ÇNG CAO" "${ICON_TOOLS}"
    menu_item "10" "Downgrade g√≥i" "‚¨á"
    menu_item "11" "Xem log g√≥i" "üìã"
    menu_item "12" "Mirror management" "üåê"

    # Font Management Section
    section_header "FONT CH·ªÆ" "üî§"
    menu_item "13" "Qu·∫£n l√Ω font ch·ªØ (Nerd Fonts, Emoji, CJK...)" "üî§"

    # Development Tools Section
    section_header "PH√ÅT TRI·ªÇN" "${ICON_FIRE}"
    menu_item "14" "M√¥i tr∆∞·ªùng ph√°t tri·ªÉn (PHP, Node.js, Java, Database...)" "${ICON_TOOLS}"

    # Install AUR Helper if not present
    if [[ -z "$aur_helper" ]]; then
        echo ""
        menu_item "15" "${YELLOW}C√†i ƒë·∫∑t YAY (AUR helper)${RESET}" "${ICON_SPARKLE}"
    fi

    # Exit option
    echo ""
    divider
    echo -e "  ${BOLD}${RED}0.${RESET}  ${ICON_ERROR}  Tho√°t"
    divider
    echo ""
    echo -en "${BOLD}${PURPLE}${ICON_ARROW}${RESET} ${CYAN}Ch·ªçn ch·ª©c nƒÉng [0-15]:${RESET} "
}

# =============================================================================
# Main Loop
# =============================================================================

main() {
    # Check if running on Arch Linux
    if ! is_arch_linux; then
        error "This script is designed for Arch Linux and Arch-based distributions only!"
        exit 1
    fi

    while true; do
        show_header
        show_main_menu
        read choice

        case $choice in
            1) install_package ;;
            2) remove_package ;;
            3) update_system ;;
            4) search_package ;;
            5) package_info ;;
            6) clean_cache ;;
            7) remove_orphans ;;
            8) list_installed ;;
            9) check_broken ;;
            10) downgrade_package ;;
            11) view_logs ;;
            12) mirror_management ;;
            13) font_manager_menu ;;
            14) dev_tools_menu ;;
            15) install_yay ;;
            0)
                clear
                echo ""
                success "T·∫°m bi·ªát! C·∫£m ∆°n b·∫°n ƒë√£ s·ª≠ d·ª•ng Arch Package Manager! ${ICON_ROCKET}"
                echo ""
                exit 0
                ;;
            *)
                error "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá! Vui l√≤ng ch·ªçn t·ª´ 0-15."
                sleep 2
                ;;
        esac
    done
}

# =============================================================================
# Run Application
# =============================================================================

main
